<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markdown Viewer & Formatter</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .app {
      max-width: 1000px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
    header h1 {
      font-size: 2rem;
      margin-bottom: 8px;
    }
    header p {
      opacity: 0.9;
      font-size: 1.1rem;
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      padding: 30px;
      margin-bottom: 20px;
    }

    /* å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .input-section {
      margin-bottom: 20px;
    }
    .input-label {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
      display: block;
    }
    textarea {
      width: 100%;
      height: 200px;
      padding: 15px;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      font-family: monospace;
      font-size: 14px;
      resize: vertical;
      transition: border-color 0.2s;
      line-height: 1.6;
    }
    textarea:focus {
      outline: none;
      border-color: #11998e;
    }
    textarea::placeholder {
      color: #adb5bd;
    }

    /* ãƒœã‚¿ãƒ³ */
    .btn {
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      width: 100%;
      justify-content: center;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .btn-secondary:hover {
      background: #5a6268;
    }
    .btn-success {
      background: #11998e;
      color: white;
    }
    .btn-success:hover {
      background: #0d7d74;
    }

    /* å‡ºåŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .output-section {
      display: none;
      margin-top: 30px;
      padding-top: 30px;
      border-top: 1px solid #e9ecef;
    }
    .output-section.show {
      display: block;
    }
    .output-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .output-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    .output-tabs {
      display: flex;
      gap: 5px;
    }
    .output-tab {
      padding: 8px 16px;
      border: none;
      background: #e9ecef;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .output-tab:hover {
      background: #dee2e6;
    }
    .output-tab.active {
      background: #11998e;
      color: white;
    }
    .output-content {
      background: #f8f9fa;
      border-radius: 12px;
      overflow: hidden;
    }
    .output-code {
      padding: 20px;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 500px;
      overflow-y: auto;
      line-height: 1.6;
    }
    .output-preview {
      display: none;
      padding: 25px;
      max-height: 500px;
      overflow-y: auto;
      line-height: 1.8;
    }
    .output-preview.show {
      display: block;
    }
    .output-code.show {
      display: block;
    }
    .output-code:not(.show) {
      display: none;
    }

    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .output-preview h1 {
      font-size: 1.8rem;
      margin: 0 0 20px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid #e9ecef;
      color: #333;
    }
    .output-preview h2 {
      font-size: 1.4rem;
      margin: 25px 0 15px 0;
      color: #333;
    }
    .output-preview h3 {
      font-size: 1.2rem;
      margin: 20px 0 10px 0;
      color: #444;
    }
    .output-preview h4, .output-preview h5, .output-preview h6 {
      font-size: 1rem;
      margin: 15px 0 10px 0;
      color: #555;
    }
    .output-preview p {
      margin: 0 0 15px 0;
      color: #444;
    }
    .output-preview ul, .output-preview ol {
      margin: 0 0 15px 0;
      padding-left: 25px;
    }
    .output-preview li {
      margin: 5px 0;
      color: #444;
    }
    .output-preview ul ul, .output-preview ol ol, .output-preview ul ol, .output-preview ol ul {
      margin: 5px 0;
    }
    .output-preview code {
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.9em;
    }
    .output-preview pre {
      background: #2d3748;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 0 0 15px 0;
    }
    .output-preview pre code {
      background: none;
      padding: 0;
      color: inherit;
    }
    .output-preview blockquote {
      border-left: 4px solid #11998e;
      margin: 0 0 15px 0;
      padding: 10px 20px;
      background: #f0fff4;
      color: #555;
    }
    .output-preview hr {
      border: none;
      border-top: 1px solid #e9ecef;
      margin: 20px 0;
    }
    .output-preview strong {
      font-weight: 600;
      color: #333;
    }
    .output-preview em {
      font-style: italic;
    }
    .output-preview a {
      color: #11998e;
      text-decoration: none;
    }
    .output-preview a:hover {
      text-decoration: underline;
    }
    .output-preview table {
      border-collapse: collapse;
      width: 100%;
      margin: 0 0 15px 0;
    }
    .output-preview th, .output-preview td {
      border: 1px solid #dee2e6;
      padding: 10px;
      text-align: left;
    }
    .output-preview th {
      background: #f8f9fa;
      font-weight: 600;
    }

    /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    .output-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .output-actions .btn {
      flex: 1;
      justify-content: center;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .message {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 15px 25px;
      border-radius: 10px;
      color: white;
      font-weight: 500;
      opacity: 0;
      transition: all 0.3s;
      z-index: 1000;
    }
    .message.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    .message.success {
      background: #11998e;
    }
    .message.error {
      background: #dc3545;
    }

    /* ç‰¹å¾´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 25px;
      padding-top: 25px;
      border-top: 1px solid #e9ecef;
    }
    .feature {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    .feature-icon {
      font-size: 20px;
      flex-shrink: 0;
    }
    .feature-text {
      font-size: 14px;
      color: #555;
    }
    .feature-text strong {
      display: block;
      color: #333;
      margin-bottom: 2px;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 600px) {
      .output-header {
        flex-direction: column;
        gap: 15px;
      }
      .output-actions {
        flex-direction: column;
      }
      .features {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Markdown Viewer</h1>
      <p>ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’è¦‹ã‚„ã™ãæ•´å½¢ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</p>
    </header>

    <div class="card">
      <!-- å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="input-section">
        <label class="input-label">ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’è²¼ã‚Šä»˜ã‘</label>
        <textarea id="input" placeholder="# è¦‹å‡ºã—

ã“ã“ã«ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„...

- ãƒªã‚¹ãƒˆé …ç›®1
- ãƒªã‚¹ãƒˆé …ç›®2
  - ãƒã‚¹ãƒˆã—ãŸãƒªã‚¹ãƒˆ

**å¤ªå­—** ã‚„ *æ–œä½“* ã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚"></textarea>
      </div>

      <!-- å¤‰æ›ãƒœã‚¿ãƒ³ -->
      <button class="btn btn-primary" id="convertBtn" onclick="convert()">
        <span>æ•´å½¢ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
        <span>â†’</span>
      </button>

      <!-- å‡ºåŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="output-section" id="outputSection">
        <div class="output-header">
          <div class="output-title">çµæœ</div>
          <div class="output-tabs">
            <button class="output-tab" onclick="switchOutput('code')">ã‚³ãƒ¼ãƒ‰</button>
            <button class="output-tab active" onclick="switchOutput('preview')">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
          </div>
        </div>
        <div class="output-content">
          <div class="output-code" id="outputCode"></div>
          <div class="output-preview show" id="outputPreview"></div>
        </div>
        <div class="output-actions">
          <button class="btn btn-success" onclick="downloadMarkdown()">
            â¬‡ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          </button>
          <button class="btn btn-secondary" onclick="copyOutput()">
            ğŸ“‹ ã‚³ãƒ”ãƒ¼
          </button>
          <button class="btn btn-secondary" onclick="clearAll()">
            ğŸ”„ ã‚¯ãƒªã‚¢
          </button>
        </div>
      </div>

      <!-- ç‰¹å¾´ -->
      <div class="features">
        <div class="feature">
          <span class="feature-icon">âœ¨</span>
          <div class="feature-text">
            <strong>è‡ªå‹•æ•´å½¢</strong>
            è¦‹å‡ºã—ã®å‰å¾Œã«ç©ºè¡Œã‚’å…¥ã‚Œã€èª­ã¿ã‚„ã™ãæ•´å½¢
          </div>
        </div>
        <div class="feature">
          <span class="feature-icon">ğŸ‘€</span>
          <div class="feature-text">
            <strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</strong>
            HTMLãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§å®Œæˆå½¢ã‚’ç¢ºèª
          </div>
        </div>
        <div class="feature">
          <span class="feature-icon">ğŸ“¥</span>
          <div class="feature-text">
            <strong>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</strong>
            æ•´å½¢æ¸ˆã¿ã®.mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="message" class="message"></div>

  <script>
    let formattedMarkdown = '';

    function convert() {
      const input = document.getElementById('input').value;

      if (!input.trim()) {
        showMessage('ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', false);
        return;
      }

      // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’æ•´å½¢
      formattedMarkdown = formatMarkdown(input);

      // ã‚³ãƒ¼ãƒ‰è¡¨ç¤º
      document.getElementById('outputCode').textContent = formattedMarkdown;

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
      document.getElementById('outputPreview').innerHTML = markdownToHtml(formattedMarkdown);

      // å‡ºåŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
      document.getElementById('outputSection').classList.add('show');
      showMessage('æ•´å½¢å®Œäº†ï¼', true);

      // å‡ºåŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’æ•´å½¢
    function formatMarkdown(md) {
      let lines = md.split('\n');
      let result = [];
      let prevLineType = 'empty';
      let inCodeBlock = false;

      for (let i = 0; i < lines.length; i++) {
        let line = lines[i];

        // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å†…ã¯ãã®ã¾ã¾
        if (line.trim().startsWith('```')) {
          inCodeBlock = !inCodeBlock;
          if (!inCodeBlock && prevLineType !== 'empty') {
            result.push('');
          }
          result.push(line);
          prevLineType = 'code';
          continue;
        }

        if (inCodeBlock) {
          result.push(line);
          prevLineType = 'code';
          continue;
        }

        // ç©ºè¡Œ
        if (line.trim() === '') {
          if (prevLineType !== 'empty') {
            result.push('');
            prevLineType = 'empty';
          }
          continue;
        }

        // è¦‹å‡ºã—
        if (line.match(/^#{1,6}\s/)) {
          if (prevLineType !== 'empty' && result.length > 0) {
            result.push('');
          }
          result.push(line);
          prevLineType = 'heading';
          continue;
        }

        // æ°´å¹³ç·š
        if (line.match(/^(-{3,}|\*{3,}|_{3,})$/)) {
          if (prevLineType !== 'empty' && result.length > 0) {
            result.push('');
          }
          result.push(line);
          prevLineType = 'hr';
          continue;
        }

        // ãƒªã‚¹ãƒˆé …ç›®
        if (line.match(/^(\s*)[-*+]\s/) || line.match(/^(\s*)\d+\.\s/)) {
          if (prevLineType !== 'list' && prevLineType !== 'empty' && result.length > 0) {
            result.push('');
          }
          result.push(line);
          prevLineType = 'list';
          continue;
        }

        // å¼•ç”¨
        if (line.match(/^>\s?/)) {
          if (prevLineType !== 'quote' && prevLineType !== 'empty' && result.length > 0) {
            result.push('');
          }
          result.push(line);
          prevLineType = 'quote';
          continue;
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«
        if (line.match(/^\|/)) {
          if (prevLineType !== 'table' && prevLineType !== 'empty' && result.length > 0) {
            result.push('');
          }
          result.push(line);
          prevLineType = 'table';
          continue;
        }

        // é€šå¸¸ã®æ®µè½
        if (prevLineType !== 'paragraph' && prevLineType !== 'empty' && result.length > 0) {
          result.push('');
        }
        // é•·ã„æ–‡ç« ã‚’èª­ã¿ã‚„ã™ãåˆ†å‰²
        const formattedLines = breakLongText(line);
        result.push(...formattedLines);
        prevLineType = 'paragraph';
      }

      // æœ«å°¾ã®ç©ºè¡Œã‚’å‰Šé™¤
      while (result.length > 0 && result[result.length - 1] === '') {
        result.pop();
      }

      return result.join('\n');
    }

    // é•·ã„æ–‡ç« ã‚’èª­ã¿ã‚„ã™ãåˆ†å‰²ï¼ˆ40æ–‡å­—ç¨‹åº¦ã§æ”¹è¡Œï¼‰
    function breakLongText(text, maxLength = 40) {
      const result = [];

      // ã¾ãšã€Œã€‚ã€ã§åˆ†å‰²
      const sentences = text.split(/(?<=ã€‚)/);

      for (const sentence of sentences) {
        const trimmed = sentence.trim();
        if (!trimmed) continue;

        // 40æ–‡å­—ä»¥ä¸‹ãªã‚‰ãã®ã¾ã¾è¿½åŠ 
        if (trimmed.length <= maxLength) {
          result.push(trimmed + '  ');
        } else {
          // 40æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã¯å¥èª­ç‚¹ã§åˆ†å‰²
          const parts = breakAtPunctuation(trimmed, maxLength);
          for (let i = 0; i < parts.length; i++) {
            if (i < parts.length - 1) {
              result.push(parts[i].replace(/\s+$/, '') + '  ');
            } else {
              result.push(parts[i] + '  ');
            }
          }
        }
      }

      // æœ€å¾Œã®è¡Œã®æœ«å°¾ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ï¼ˆæ®µè½æœ«ã¯ä¸è¦ï¼‰
      if (result.length > 0) {
        result[result.length - 1] = result[result.length - 1].replace(/\s+$/, '');
      }

      return result.length > 0 ? result : [text];
    }

    // å¥èª­ç‚¹ã§åˆ†å‰²ï¼ˆã€Œã€‚ã€ãŒãªã„é•·ã„æ–‡ç”¨ï¼‰
    function breakAtPunctuation(text, maxLength) {
      const result = [];
      let remaining = text;
      const punctuations = ['ã€', 'ï¼Œ', 'ï¼', 'ï¼Ÿ', 'ï¼‰', 'ã€', 'ã€', 'ï¼›', 'ï¼š'];

      while (remaining.length > maxLength) {
        let breakPoint = -1;

        // ã¾ãšmaxLengthä»¥å†…ã§æœ€å¾Œã®å¥èª­ç‚¹ã‚’æ¢ã™
        for (let i = maxLength - 1; i >= 0; i--) {
          if (punctuations.includes(remaining[i])) {
            breakPoint = i + 1;
            break;
          }
        }

        // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€maxLengthä»¥é™ã®æœ€åˆã®å¥èª­ç‚¹ã‚’æ¢ã™
        if (breakPoint === -1) {
          for (let i = maxLength; i < remaining.length; i++) {
            if (punctuations.includes(remaining[i])) {
              breakPoint = i + 1;
              break;
            }
          }
        }

        // ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯åˆ†å‰²ã—ãªã„
        if (breakPoint === -1) {
          break;
        }

        result.push(remaining.substring(0, breakPoint).trim() + '  ');
        remaining = remaining.substring(breakPoint).trim();
      }

      if (remaining) {
        result.push(remaining);
      }

      return result;
    }

    // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’HTMLã«å¤‰æ›
    function markdownToHtml(md) {
      let html = md;

      // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯
      html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
        return `<pre><code>${escapeHtml(code.trim())}</code></pre>`;
      });

      // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

      // è¦‹å‡ºã—
      html = html.replace(/^###### (.+)$/gm, '<h6>$1</h6>');
      html = html.replace(/^##### (.+)$/gm, '<h5>$1</h5>');
      html = html.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
      html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
      html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
      html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

      // æ°´å¹³ç·š
      html = html.replace(/^(-{3,}|\*{3,}|_{3,})$/gm, '<hr>');

      // å¤ªå­—ãƒ»æ–œä½“
      html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
      html = html.replace(/___(.+?)___/g, '<strong><em>$1</em></strong>');
      html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
      html = html.replace(/_(.+?)_/g, '<em>$1</em>');

      // ãƒªãƒ³ã‚¯
      html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

      // ç”»åƒ
      html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" style="max-width:100%;">');

      // å¼•ç”¨
      html = html.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');
      html = html.replace(/<\/blockquote>\n<blockquote>/g, '\n');

      // ãƒ†ãƒ¼ãƒ–ãƒ«
      html = html.replace(/^\|(.+)\|$/gm, (match, content) => {
        const cells = content.split('|').map(c => c.trim());
        if (cells.every(c => c.match(/^[-:]+$/))) {
          return '<!-- table separator -->';
        }
        const isHeader = !html.includes('<!-- table separator -->') ||
                         html.lastIndexOf('<table>') > html.lastIndexOf('<!-- table separator -->');
        const tag = isHeader ? 'th' : 'td';
        return `<tr>${cells.map(c => `<${tag}>${c}</${tag}>`).join('')}</tr>`;
      });
      html = html.replace(/(<tr>.*<\/tr>)/s, (match) => {
        if (match.includes('<th>')) {
          return `<table>${match}`;
        }
        return match;
      });
      html = html.replace(/<!-- table separator -->/g, '');
      html = html.replace(/<\/tr>\n(?!<tr>)/g, '</tr></table>\n');

      // ãƒªã‚¹ãƒˆå‡¦ç†
      html = processLists(html);

      // æ®µè½
      html = html.split('\n\n').map(block => {
        block = block.trim();
        if (!block) return '';
        if (block.startsWith('<')) return block;
        return `<p>${block.replace(/\n/g, '<br>')}</p>`;
      }).join('\n');

      return html;
    }

    // ãƒªã‚¹ãƒˆå‡¦ç†
    function processLists(html) {
      const lines = html.split('\n');
      let result = [];
      let listStack = [];

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const ulMatch = line.match(/^(\s*)[-*+]\s+(.+)$/);
        const olMatch = line.match(/^(\s*)\d+\.\s+(.+)$/);

        if (ulMatch || olMatch) {
          const indent = (ulMatch || olMatch)[1].length;
          const content = (ulMatch || olMatch)[2];
          const listType = ulMatch ? 'ul' : 'ol';

          // ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ãƒªã‚¹ãƒˆã‚’èª¿æ•´
          while (listStack.length > 0 && listStack[listStack.length - 1].indent >= indent) {
            const popped = listStack.pop();
            result.push(`</${popped.type}>`);
          }

          if (listStack.length === 0 || listStack[listStack.length - 1].indent < indent) {
            result.push(`<${listType}>`);
            listStack.push({ type: listType, indent: indent });
          }

          result.push(`<li>${content}</li>`);
        } else {
          // ãƒªã‚¹ãƒˆã‚’é–‰ã˜ã‚‹
          while (listStack.length > 0) {
            const popped = listStack.pop();
            result.push(`</${popped.type}>`);
          }
          result.push(line);
        }
      }

      // æ®‹ã‚Šã®ãƒªã‚¹ãƒˆã‚’é–‰ã˜ã‚‹
      while (listStack.length > 0) {
        const popped = listStack.pop();
        result.push(`</${popped.type}>`);
      }

      return result.join('\n');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // å‡ºåŠ›ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchOutput(type) {
      document.querySelectorAll('.output-tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');

      document.getElementById('outputCode').classList.toggle('show', type === 'code');
      document.getElementById('outputPreview').classList.toggle('show', type === 'preview');
    }

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadMarkdown() {
      if (!formattedMarkdown) {
        showMessage('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“', false);
        return;
      }

      const blob = new Blob([formattedMarkdown], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'document.md';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showMessage('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', true);
    }

    // ã‚³ãƒ”ãƒ¼
    function copyOutput() {
      if (!formattedMarkdown) {
        showMessage('ã‚³ãƒ”ãƒ¼ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“', false);
        return;
      }

      navigator.clipboard.writeText(formattedMarkdown).then(() => {
        showMessage('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', true);
      }).catch(() => {
        showMessage('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', false);
      });
    }

    // ã‚¯ãƒªã‚¢
    function clearAll() {
      document.getElementById('input').value = '';
      document.getElementById('outputCode').textContent = '';
      document.getElementById('outputPreview').innerHTML = '';
      document.getElementById('outputSection').classList.remove('show');
      formattedMarkdown = '';
      showMessage('ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', true);
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showMessage(text, success) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = 'message show ' + (success ? 'success' : 'error');
      setTimeout(() => {
        msg.className = 'message';
      }, 2500);
    }

    // å…¥åŠ›æ™‚ã«ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    document.getElementById('input').addEventListener('input', function() {
      document.getElementById('convertBtn').disabled = !this.value.trim();
    });
  </script>
</body>
</html>
