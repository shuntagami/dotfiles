<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Markdown Viewer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f1f5f9;
        --bg-tertiary: #e2e8f0;
        --text-primary: #1a1a1a;
        --text-secondary: #65717b;
        --text-tertiary: #9caab7;
        --border: #e4edf4;
        --accent: #3ea8ff;
        --accent-hover: #0f83fd;
        --accent-bg: rgba(62, 168, 255, 0.1);
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.12);
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html,
      body {
        height: 100%;
      }

      html {
        font-family:
          "Noto Sans JP",
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      body {
        background: var(--bg-primary);
        color: var(--text-primary);
        display: flex;
        flex-direction: column;
      }

      /* Header - Zenn style */
      .header {
        flex-shrink: 0;
        background: var(--bg-primary);
        border-bottom: 1px solid var(--border);
        padding: 0 24px;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 24px;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 4px;
        text-decoration: none;
      }

      .logo-mark {
        font-size: 28px;
        font-weight: 700;
        color: var(--accent);
        font-style: italic;
        letter-spacing: -2px;
      }

      .logo-text {
        font-size: 13px;
        color: var(--text-secondary);
        margin-left: 8px;
        padding-left: 12px;
        border-left: 1px solid var(--border);
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .btn {
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        font-family: inherit;
      }

      .btn-primary {
        background: var(--accent);
        color: white;
      }

      .btn-primary:hover {
        background: var(--accent-hover);
      }

      .btn-ghost {
        background: transparent;
        color: var(--text-secondary);
      }

      .btn-ghost:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
      }

      .btn-outline {
        background: var(--bg-primary);
        color: var(--text-primary);
        border: 1px solid var(--border);
      }

      .btn-outline:hover {
        background: var(--bg-secondary);
        border-color: var(--text-tertiary);
      }

      /* Main Layout */
      .main {
        flex: 1;
        display: flex;
        overflow: hidden;
        padding: 20px;
        gap: 20px;
        background: var(--bg-secondary);
      }

      /* Pane */
      .pane {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        background: var(--bg-primary);
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        overflow: hidden;
      }

      .pane-header {
        flex-shrink: 0;
        padding: 10px 16px;
        background: var(--bg-primary);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 12px;
      }

      .pane-header.hidden {
        display: none;
      }

      .pane-content {
        flex: 1;
        overflow: hidden;
        background: var(--bg-primary);
        display: flex;
        flex-direction: column;
      }

      /* Editor */
      .editor-input {
        width: 100%;
        height: 100%;
        padding: 20px 24px;
        border: none;
        background: transparent;
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 14px;
        line-height: 1.8;
        color: var(--text-primary);
        resize: none;
        overflow-y: auto;
      }

      .editor-input:focus {
        outline: none;
      }

      .editor-input::placeholder {
        color: var(--text-tertiary);
      }

      /* Output Tabs */
      .output-tabs {
        display: flex;
        background: var(--bg-secondary);
        padding: 3px;
        border-radius: 8px;
      }

      .output-tab {
        padding: 6px 14px;
        font-size: 13px;
        font-weight: 500;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.15s;
        font-family: inherit;
      }

      .output-tab:hover:not(.active) {
        color: var(--text-primary);
      }

      .output-tab.active {
        background: var(--bg-primary);
        color: var(--accent);
        box-shadow: var(--shadow-sm);
      }

      /* Output Code */
      .output-code {
        display: none;
        height: 100%;
        padding: 20px 24px;
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 14px;
        line-height: 1.8;
        white-space: pre-wrap;
        word-break: break-word;
        color: var(--text-primary);
        overflow: auto;
      }

      .output-code.show {
        display: block;
      }

      /* Preview - Zenn article style */
      .output-preview {
        display: none;
        height: 100%;
        padding: 32px 40px;
        overflow: auto;
      }

      .output-preview.show {
        display: block;
      }

      .output-preview h1 {
        font-size: 1.9em;
        font-weight: 700;
        margin: 0 0 24px 0;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
        line-height: 1.4;
        letter-spacing: -0.01em;
      }

      .output-preview h2 {
        font-size: 1.5em;
        font-weight: 700;
        margin: 48px 0 16px 0;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
        line-height: 1.4;
      }

      .output-preview h3 {
        font-size: 1.25em;
        font-weight: 700;
        margin: 40px 0 12px 0;
        line-height: 1.4;
      }

      .output-preview h4,
      .output-preview h5,
      .output-preview h6 {
        font-size: 1.1em;
        font-weight: 700;
        margin: 32px 0 10px 0;
        line-height: 1.4;
      }

      .output-preview p {
        margin: 0 0 24px 0;
        color: var(--text-primary);
        font-size: 16px;
        line-height: 1.9;
      }

      .output-preview ul,
      .output-preview ol {
        margin: 0 0 24px 0;
        padding-left: 28px;
      }

      .output-preview li {
        margin: 8px 0;
        color: var(--text-primary);
        font-size: 16px;
        line-height: 1.8;
      }

      .output-preview li::marker {
        color: var(--accent);
      }

      .output-preview code {
        background: var(--bg-secondary);
        padding: 3px 8px;
        border-radius: 4px;
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 0.9em;
        color: var(--text-primary);
      }

      .output-preview pre {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 20px 24px;
        border-radius: var(--radius-md);
        overflow-x: auto;
        margin: 0 0 24px 0;
        font-size: 14px;
        line-height: 1.7;
      }

      .output-preview pre code {
        background: none;
        padding: 0;
        color: inherit;
        font-size: inherit;
      }

      .output-preview blockquote {
        border-left: 4px solid var(--accent);
        margin: 0 0 24px 0;
        padding: 12px 20px;
        background: var(--accent-bg);
        border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      }

      .output-preview blockquote p {
        margin: 0;
        color: var(--text-primary);
      }

      .output-preview hr {
        border: none;
        border-top: 1px solid var(--border);
        margin: 48px 0;
      }

      .output-preview strong {
        font-weight: 700;
        color: var(--text-primary);
      }

      .output-preview a {
        color: var(--accent);
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: border-color 0.15s;
      }

      .output-preview a:hover {
        border-bottom-color: var(--accent);
      }

      .output-preview table {
        border-collapse: collapse;
        width: 100%;
        margin: 0 0 24px 0;
        font-size: 15px;
      }

      .output-preview th,
      .output-preview td {
        border: 1px solid var(--border);
        padding: 12px 16px;
        text-align: left;
      }

      .output-preview th {
        background: var(--bg-secondary);
        font-weight: 700;
        font-size: 14px;
      }

      .output-preview img {
        max-width: 100%;
        border-radius: var(--radius-md);
      }

      /* Empty state */
      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-tertiary);
        text-align: center;
        padding: 48px;
      }

      .empty-state-icon {
        font-size: 56px;
        margin-bottom: 20px;
        opacity: 0.6;
      }

      .empty-state-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }

      .empty-state-text {
        font-size: 14px;
        color: var(--text-tertiary);
        line-height: 1.6;
      }

      /* Toast - Zenn style */
      .toast {
        position: fixed;
        bottom: 32px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        padding: 12px 24px;
        background: var(--bg-primary);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 10px;
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
        border: 1px solid var(--border);
      }

      .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }

      .toast.success .toast-icon {
        color: #22c55e;
      }

      .toast.error .toast-icon {
        color: #ef4444;
      }

      .toast-icon {
        font-size: 18px;
      }

      /* TOC Dropdown - Zenn style */
      .toc-wrapper {
        position: relative;
      }

      .toc-toggle {
        padding: 8px 14px;
        font-size: 13px;
        font-weight: 500;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        background: var(--bg-primary);
        color: var(--text-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.15s;
        font-family: inherit;
      }

      .toc-toggle:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
      }

      .toc-toggle .arrow {
        font-size: 10px;
        transition: transform 0.2s;
      }

      .toc-toggle.open .arrow {
        transform: rotate(180deg);
      }

      .toc-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        width: 300px;
        max-height: 420px;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-8px);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 100;
        display: flex;
        flex-direction: column;
      }

      .toc-dropdown.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .toc-header {
        padding: 14px 18px;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .toc-header::before {
        content: "";
        display: block;
        width: 3px;
        height: 14px;
        background: var(--accent);
        border-radius: 2px;
      }

      .toc-content {
        flex: 1;
        overflow-y: auto;
        padding: 8px 0;
      }

      .toc-empty {
        padding: 24px 18px;
        color: var(--text-tertiary);
        font-size: 14px;
        text-align: center;
      }

      .toc-item {
        display: block;
        padding: 10px 18px;
        font-size: 14px;
        color: var(--text-secondary);
        text-decoration: none;
        transition: all 0.15s;
        cursor: pointer;
        border-left: 2px solid transparent;
      }

      .toc-item:hover {
        background: var(--bg-secondary);
        color: var(--accent);
        border-left-color: var(--accent);
      }

      .toc-item.level-2 {
        padding-left: 32px;
        font-size: 13px;
      }

      .toc-item.level-3 {
        padding-left: 46px;
        font-size: 13px;
        color: var(--text-tertiary);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .main {
          flex-direction: column;
          padding: 16px;
          gap: 16px;
        }

        .pane {
          flex: none;
          min-height: 300px;
        }

        .header {
          padding: 0 16px;
        }

        .header-actions .btn span:not(.btn-icon) {
          display: none;
        }

        .btn {
          padding: 8px 12px;
        }

        .logo-text {
          display: none;
        }

        .output-preview {
          padding: 24px 20px;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-left">
        <div class="logo">
          <span class="logo-mark">//</span>
          <span class="logo-text">MarkdownÊï¥ÂΩ¢„ÉÑ„Éº„É´</span>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-ghost" onclick="copyOutput()">
          <span class="btn-icon">üìã</span>
          <span>„Ç≥„Éî„Éº</span>
        </button>
        <button class="btn btn-outline" onclick="downloadMarkdown()">
          <span class="btn-icon">‚¨á</span>
          <span>„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</span>
        </button>
        <button class="btn btn-primary" onclick="convert()">
          <span>Êï¥ÂΩ¢„Åô„Çã</span>
        </button>
      </div>
    </header>

    <main class="main">
      <!-- Input Pane -->
      <div class="pane">
        <div class="pane-content">
          <textarea
            class="editor-input"
            id="input"
            placeholder="„Åì„Åì„Å´Markdown„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ

Âè•Ë™≠ÁÇπÔºà„ÄÅ„ÄÇÔºâ„ÅßËá™ÂãïÊîπË°å„Åó„Å¶Ë™≠„Åø„ÇÑ„Åô„Åè„Åó„Åæ„Åô„ÄÇ
‚åò + Enter „ÅßÊï¥ÂΩ¢„ÇíÂÆüË°å„Åß„Åç„Åæ„Åô„ÄÇ"
          ></textarea>
        </div>
      </div>

      <!-- Output Pane -->
      <div class="pane">
        <div class="pane-header">
          <div class="output-tabs">
            <button
              class="output-tab active"
              onclick="switchOutput('preview', event)"
            >
              „Éó„É¨„Éì„É•„Éº
            </button>
            <button class="output-tab" onclick="switchOutput('code', event)">
              „Ç≥„Éº„Éâ
            </button>
          </div>
          <div class="toc-wrapper">
            <button class="toc-toggle" id="tocToggle" onclick="toggleToc()">
              <span>ÁõÆÊ¨°</span>
              <span class="arrow">‚ñº</span>
            </button>
            <div class="toc-dropdown" id="tocDropdown">
              <div class="toc-header">ÁõÆÊ¨°</div>
              <nav class="toc-content" id="tocContent">
                <div class="toc-empty">Ë¶ãÂá∫„Åó„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
              </nav>
            </div>
          </div>
        </div>
        <div class="pane-content">
          <div class="output-preview show" id="outputPreview">
            <div class="empty-state">
              <div class="empty-state-icon">üìù</div>
              <div class="empty-state-title">Èï∑„ÅÑÊñáÁ´†„ÇíË™≠„Åø„ÇÑ„Åô„ÅèÊï¥ÂΩ¢</div>
              <div class="empty-state-text">
                Âè•Ë™≠ÁÇπ„ÅßËá™ÂãïÊîπË°å„Åó„Å¶ÊñáÂ≠óÂ£Å„ÇíËß£Ê∂à„Åó„Åæ„Åô
              </div>
            </div>
          </div>
          <div class="output-code" id="outputCode"></div>
        </div>
      </div>
    </main>

    <div id="toast" class="toast">
      <span id="toastIcon" class="toast-icon"></span>
      <span id="toastText"></span>
    </div>

    <script>
      let formattedMarkdown = "";

      function convert() {
        const input = document.getElementById("input").value;

        if (!input.trim()) {
          showToast("„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", false);
          return;
        }

        formattedMarkdown = formatMarkdown(input);
        generateToc(formattedMarkdown);

        document.getElementById("outputCode").textContent = formattedMarkdown;
        document.getElementById("outputPreview").innerHTML =
          markdownToHtml(formattedMarkdown);

        showToast("Êï¥ÂΩ¢„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü", true);
      }

      function formatMarkdown(md) {
        let lines = md.split("\n");
        let result = [];
        let prevLineType = "empty";
        let inCodeBlock = false;

        for (let i = 0; i < lines.length; i++) {
          let line = lines[i];

          if (line.trim().startsWith("```")) {
            inCodeBlock = !inCodeBlock;
            if (!inCodeBlock && prevLineType !== "empty") {
              result.push("");
            }
            result.push(line);
            prevLineType = "code";
            continue;
          }

          if (inCodeBlock) {
            result.push(line);
            prevLineType = "code";
            continue;
          }

          if (line.trim() === "") {
            if (prevLineType !== "empty") {
              result.push("");
              prevLineType = "empty";
            }
            continue;
          }

          if (line.match(/^#{1,6}\s/)) {
            if (prevLineType !== "empty" && result.length > 0) {
              result.push("");
            }
            result.push(line);
            prevLineType = "heading";
            continue;
          }

          if (line.match(/^(-{3,}|\*{3,}|_{3,})$/)) {
            if (prevLineType !== "empty" && result.length > 0) {
              result.push("");
            }
            result.push(line);
            prevLineType = "hr";
            continue;
          }

          if (line.match(/^(\s*)[-*+]\s/) || line.match(/^(\s*)\d+\.\s/)) {
            if (
              prevLineType !== "list" &&
              prevLineType !== "empty" &&
              result.length > 0
            ) {
              result.push("");
            }
            result.push(line);
            prevLineType = "list";
            continue;
          }

          if (line.match(/^>\s?/)) {
            if (
              prevLineType !== "quote" &&
              prevLineType !== "empty" &&
              result.length > 0
            ) {
              result.push("");
            }
            result.push(line);
            prevLineType = "quote";
            continue;
          }

          if (line.match(/^\|/)) {
            if (
              prevLineType !== "table" &&
              prevLineType !== "empty" &&
              result.length > 0
            ) {
              result.push("");
            }
            result.push(line);
            prevLineType = "table";
            continue;
          }

          if (
            prevLineType !== "paragraph" &&
            prevLineType !== "empty" &&
            result.length > 0
          ) {
            result.push("");
          }
          const formattedLines = breakLongText(line);
          result.push(...formattedLines);
          prevLineType = "paragraph";
        }

        while (result.length > 0 && result[result.length - 1] === "") {
          result.pop();
        }

        return result.join("\n");
      }

      function breakLongText(text, maxLength = 40) {
        const result = [];
        const sentences = text.split(/(?<=„ÄÇ)/);

        for (const sentence of sentences) {
          const trimmed = sentence.trim();
          if (!trimmed) continue;

          if (trimmed.length <= maxLength) {
            result.push(trimmed + "  ");
          } else {
            const parts = breakAtPunctuation(trimmed, maxLength);
            for (let i = 0; i < parts.length; i++) {
              if (i < parts.length - 1) {
                result.push(parts[i].replace(/\s+$/, "") + "  ");
              } else {
                result.push(parts[i] + "  ");
              }
            }
          }
        }

        if (result.length > 0) {
          result[result.length - 1] = result[result.length - 1].replace(
            /\s+$/,
            "",
          );
        }

        return result.length > 0 ? result : [text];
      }

      function breakAtPunctuation(text, maxLength) {
        const result = [];
        let remaining = text;
        const punctuations = [
          "„ÄÅ",
          "Ôºå",
          "ÔºÅ",
          "Ôºü",
          "Ôºâ",
          "„Äç",
          "„Äè",
          "Ôºõ",
          "Ôºö",
        ];

        while (remaining.length > maxLength) {
          let breakPoint = -1;

          for (let i = maxLength - 1; i >= 0; i--) {
            if (punctuations.includes(remaining[i])) {
              breakPoint = i + 1;
              break;
            }
          }

          if (breakPoint === -1) {
            for (let i = maxLength; i < remaining.length; i++) {
              if (punctuations.includes(remaining[i])) {
                breakPoint = i + 1;
                break;
              }
            }
          }

          if (breakPoint === -1) {
            break;
          }

          result.push(remaining.substring(0, breakPoint).trim() + "  ");
          remaining = remaining.substring(breakPoint).trim();
        }

        if (remaining) {
          result.push(remaining);
        }

        return result;
      }

      function markdownToHtml(md) {
        let html = md;
        let headingIndex = 0;

        html = html.replace(/^(#{1,6})\s+(.+)$/gm, (match, hashes, text) => {
          const level = hashes.length;
          const id = "heading-" + headingIndex++;
          return `<h${level} id="${id}">${text}</h${level}>`;
        });

        html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
          return `<pre><code>${escapeHtml(code.trim())}</code></pre>`;
        });

        html = html.replace(/`([^`]+)`/g, "<code>$1</code>");

        html = html.replace(/^(-{3,}|\*{3,}|_{3,})$/gm, "<hr>");

        html = html.replace(
          /\*\*\*(.+?)\*\*\*/g,
          "<strong><em>$1</em></strong>"
        );
        html = html.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
        html = html.replace(/\*(.+?)\*/g, "<em>$1</em>");
        html = html.replace(/___(.+?)___/g, "<strong><em>$1</em></strong>");
        html = html.replace(/__(.+?)__/g, "<strong>$1</strong>");
        html = html.replace(/_(.+?)_/g, "<em>$1</em>");

        html = html.replace(
          /\[([^\]]+)\]\(([^)]+)\)/g,
          '<a href="$2" target="_blank">$1</a>'
        );
        html = html.replace(
          /!\[([^\]]*)\]\(([^)]+)\)/g,
          '<img src="$2" alt="$1" style="max-width:100%;">'
        );

        html = html.replace(/^> (.+)$/gm, "<blockquote>$1</blockquote>");
        html = html.replace(/<\/blockquote>\n<blockquote>/g, "\n");

        html = html.replace(/^\|(.+)\|$/gm, (match, content) => {
          const cells = content.split("|").map((c) => c.trim());
          if (cells.every((c) => c.match(/^[-:]+$/))) {
            return "<!-- table separator -->";
          }
          const isHeader =
            !html.includes("<!-- table separator -->") ||
            html.lastIndexOf("<table>") >
              html.lastIndexOf("<!-- table separator -->");
          const tag = isHeader ? "th" : "td";
          return `<tr>${cells.map((c) => `<${tag}>${c}</${tag}>`).join("")}</tr>`;
        });
        html = html.replace(/(<tr>.*<\/tr>)/s, (match) => {
          if (match.includes("<th>")) {
            return `<table>${match}`;
          }
          return match;
        });
        html = html.replace(/<!-- table separator -->/g, "");
        html = html.replace(/<\/tr>\n(?!<tr>)/g, "</tr></table>\n");

        html = processLists(html);

        html = html
          .split("\n\n")
          .map((block) => {
            block = block.trim();
            if (!block) return "";
            if (block.startsWith("<")) return block;
            return `<p>${block.replace(/\n/g, "<br>")}</p>`;
          })
          .join("\n");

        return html;
      }

      function processLists(html) {
        const lines = html.split("\n");
        let result = [];
        let listStack = [];

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          const ulMatch = line.match(/^(\s*)[-*+]\s+(.+)$/);
          const olMatch = line.match(/^(\s*)\d+\.\s+(.+)$/);

          if (ulMatch || olMatch) {
            const indent = (ulMatch || olMatch)[1].length;
            const content = (ulMatch || olMatch)[2];
            const listType = ulMatch ? "ul" : "ol";

            while (
              listStack.length > 0 &&
              listStack[listStack.length - 1].indent >= indent
            ) {
              const popped = listStack.pop();
              result.push(`</${popped.type}>`);
            }

            if (
              listStack.length === 0 ||
              listStack[listStack.length - 1].indent < indent
            ) {
              result.push(`<${listType}>`);
              listStack.push({ type: listType, indent: indent });
            }

            result.push(`<li>${content}</li>`);
          } else {
            while (listStack.length > 0) {
              const popped = listStack.pop();
              result.push(`</${popped.type}>`);
            }
            result.push(line);
          }
        }

        while (listStack.length > 0) {
          const popped = listStack.pop();
          result.push(`</${popped.type}>`);
        }

        return result.join("\n");
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function switchOutput(type, event) {
        document
          .querySelectorAll(".output-tab")
          .forEach((tab) => tab.classList.remove("active"));
        event.target.classList.add("active");

        document
          .getElementById("outputCode")
          .classList.toggle("show", type === "code");
        document
          .getElementById("outputPreview")
          .classList.toggle("show", type === "preview");
      }

      function downloadMarkdown() {
        if (!formattedMarkdown) {
          showToast("ÂÖà„Å´Êï¥ÂΩ¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ", false);
          return;
        }

        const blob = new Blob([formattedMarkdown], { type: "text/markdown" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "document.md";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast("„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü", true);
      }

      function copyOutput() {
        if (!formattedMarkdown) {
          showToast("ÂÖà„Å´Êï¥ÂΩ¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ", false);
          return;
        }

        navigator.clipboard
          .writeText(formattedMarkdown)
          .then(() => {
            showToast("„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü", true);
          })
          .catch(() => {
            showToast("„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü", false);
          });
      }

      function showToast(text, success) {
        const toast = document.getElementById("toast");
        const icon = document.getElementById("toastIcon");
        const textEl = document.getElementById("toastText");

        icon.textContent = success ? "‚úì" : "‚úï";
        textEl.textContent = text;
        toast.className = "toast show " + (success ? "success" : "error");

        setTimeout(() => {
          toast.className = "toast";
        }, 2500);
      }

      // Keyboard shortcut
      document.addEventListener("keydown", (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === "Enter") {
          e.preventDefault();
          convert();
        }
      });

      // TOC functions
      function toggleToc() {
        const toggle = document.getElementById("tocToggle");
        const dropdown = document.getElementById("tocDropdown");
        toggle.classList.toggle("open");
        dropdown.classList.toggle("open");
      }

      // Close dropdown when clicking outside
      document.addEventListener("click", (e) => {
        const wrapper = document.querySelector(".toc-wrapper");
        if (wrapper && !wrapper.contains(e.target)) {
          document.getElementById("tocToggle").classList.remove("open");
          document.getElementById("tocDropdown").classList.remove("open");
        }
      });

      function generateToc(markdown) {
        const tocContent = document.getElementById("tocContent");
        const headings = [];
        const lines = markdown.split("\n");
        let headingIndex = 0;

        lines.forEach((line) => {
          const match = line.match(/^(#{1,3})\s+(.+)$/);
          if (match) {
            const level = match[1].length;
            const text = match[2];
            const id = "heading-" + headingIndex;
            headings.push({ level, text, id });
            headingIndex++;
          }
        });

        if (headings.length === 0) {
          tocContent.innerHTML = '<div class="toc-empty">Ë¶ãÂá∫„Åó„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
          return headings;
        }

        tocContent.innerHTML = headings
          .map(
            (h) =>
              `<a class="toc-item level-${h.level}" onclick="scrollToHeading('${h.id}')">${h.text}</a>`
          )
          .join("");

        return headings;
      }

      function scrollToHeading(id) {
        const element = document.getElementById(id);
        const previewPane = document.getElementById("outputPreview");
        if (element && previewPane) {
          const offset = element.offsetTop - previewPane.offsetTop;
          previewPane.scrollTo({ top: offset, behavior: "smooth" });
        }
        // Close TOC dropdown
        document.getElementById("tocToggle").classList.remove("open");
        document.getElementById("tocDropdown").classList.remove("open");
      }
    </script>
  </body>
</html>
