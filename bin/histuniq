#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

const filename = path.join(process.env.HOME, '.zsh_history');
const lines = [];

const raw = fs.readFileSync(filename, 'utf8').split('\n');
for (const rawLine of raw) {
  try {
    const line = rawLine;
    if (line === '') continue;
    if (line.length > 300) continue;
    if ((line.split("'").length - 1) % 2 === 1) continue;
    if ((line.split('"').length - 1) % 2 === 1) continue;
    if ((line.split('`').length - 1) % 2 === 1) continue;
    // ASCII check (equivalent to NKF.guess == ASCII)
    if (!/^[\x00-\x7F]*$/.test(line)) {
      console.log(`ignored: ${line}`);
      continue;
    }
    lines.push(line.trim().replace(/ +/g, ' '));
  } catch {
    console.log(`ignored: ${rawLine}`);
  }
}

const uniqed = [...new Set(lines)];

const blacklist = uniqed.filter(l => l.startsWith('D='));
const filtered = uniqed.filter(l => !l.startsWith('D='));
if (blacklist.length > 0) {
  filtered.unshift(blacklist[blacklist.length - 1]);
}

console.log(`log line: ${filtered.length}`);

const result = filtered.join('\n') + '\n';

fs.writeFileSync(filename, result);
console.log(`${filename} saved`);
fs.writeFileSync(`${filename}.bk`, result);
console.log(`${filename}.bk saved`);
