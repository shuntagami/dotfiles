#!/usr/bin/env node

const cities = [
  ['東京 (日本)',          'Asia/Tokyo'],
  ['ハワイ (米国)',        'Pacific/Honolulu'],
  ['ニューヨーク (米国)',  'America/New_York'],
  ['ロンドン (英国)',      'Europe/London'],
  ['パリ (仏国)',          'Europe/Paris'],
  ['シンガポール',         'Asia/Singapore'],
  ['シドニー (豪州)',      'Australia/Sydney'],
];

const inputTime = process.argv[2];
let baseDate;

try {
  if (inputTime) {
    const [h, m] = inputTime.split(':').map(Number);
    const now = new Date();
    baseDate = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate(), h - 9, m || 0));
    console.log(`--- 日本時間 [${inputTime}] を各都市に変換 ---`);
  } else {
    baseDate = new Date();
    console.log('--- 世界の現在時刻 (日本との時差) ---');
  }
} catch {
  console.log('エラー: 時間の形式が正しくありません (例: 15:00)');
  process.exit(1);
}

function getUtcOffsetHours(zone, date) {
  const utcStr = date.toLocaleString('en-US', { timeZone: 'UTC' });
  const tzStr = date.toLocaleString('en-US', { timeZone: zone });
  return (new Date(tzStr) - new Date(utcStr)) / 3600000;
}

function displayWidth(str) {
  let w = 0;
  for (const ch of str) {
    const c = ch.codePointAt(0);
    w += (c >= 0x1100 && c <= 0x115F) || (c >= 0x2E80 && c <= 0x33BF) ||
         (c >= 0x3400 && c <= 0x4DBF) || (c >= 0x4E00 && c <= 0x9FFF) ||
         (c >= 0xF900 && c <= 0xFAFF) || (c >= 0xFF01 && c <= 0xFF60) ||
         (c >= 0x3040 && c <= 0x309F) || (c >= 0x30A0 && c <= 0x30FF) ? 2 : 1;
  }
  return w;
}

function padEndCJK(str, width) {
  return str + ' '.repeat(Math.max(0, width - displayWidth(str)));
}

console.log(`${padEndCJK('都市', 18)}| ${padEndCJK('現地時間', 19)}| 日本との時差`);
console.log('-'.repeat(60));

for (const [name, zone] of cities) {
  const fmt = new Intl.DateTimeFormat('sv-SE', {
    timeZone: zone,
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', hour12: false,
  });
  const localStr = fmt.format(baseDate);
  const offset = getUtcOffsetHours(zone, baseDate);
  const diff = Math.round(offset - 9);
  const diffStr = (diff >= 0 ? `+${diff}h` : `${diff}h`).padStart(5);
  console.log(`${padEndCJK(name, 17)} | ${localStr} | ${diffStr}`);
}
