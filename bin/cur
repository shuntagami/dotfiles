#!/usr/bin/env node

const https = require('https');

const HELP = `  Usage: cur FROM [TO] AMOUNT
         (TO を省略すると JPY が既定)

  Example:
      cur USD 100         # USD → JPY
      cur EUR GBP 250     # EUR → GBP
      cur AUD USD 300`;

const args = process.argv.slice(2);
if (!args.length || args[0] === '-h' || args[0] === '--help') {
  console.error(HELP);
  process.exit(1);
}

let from, to, amount;
if (args.length === 3) {
  [from, to, amount] = args;
} else if (args.length === 2) {
  [from, amount] = args;
  to = 'JPY';
} else {
  console.error(HELP);
  process.exit(1);
}

amount = parseFloat(amount);
if (isNaN(amount)) {
  console.error('AMOUNT には数値を指定してください');
  process.exit(1);
}
from = from.toUpperCase();
to = to.toUpperCase();

function formatNumber(n) {
  const s = n % 1 === 0 ? String(n) : n.toFixed(2);
  const [int, dec] = s.split('.');
  const formatted = int.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  return dec ? `${formatted}.${dec}` : formatted;
}

https.get(`https://api.exchangerate-api.com/v4/latest/${from}`, res => {
  let data = '';
  res.on('data', chunk => data += chunk);
  res.on('end', () => {
    if (res.statusCode !== 200) {
      console.error('為替レートの取得に失敗しました');
      process.exit(1);
    }
    const rate = JSON.parse(data).rates[to];
    if (!rate) {
      console.error(`Currency code '${to}' not found.`);
      process.exit(1);
    }
    const result = Math.round(amount * rate * 100) / 100;
    console.log(`${formatNumber(amount)} ${from} is approximately ${formatNumber(result)} ${to}.`);
  });
}).on('error', () => {
  console.error('為替レートの取得に失敗しました');
  process.exit(1);
});
