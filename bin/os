#!/usr/bin/env ruby

HELP = <<~EOS
  display os version

  $ os
  Ubuntu 17.04 zesty
  macOS 26.0 Tahoe
EOS

if ARGV[0] == "-h"
  puts HELP
  exit 0
end

uname = `uname`.strip

########################################
# Linux
########################################
if uname =~ /Linux/
  path = if File.exist?("/etc/lsb-release")
           "/etc/lsb-release"
         elsif File.exist?("/etc/os-release")
           "/etc/os-release"
         end

  if path
    kv = File.read(path)
             .lines
             .reject { |e| e.start_with?("#") }
             .map { |e| e.strip }
             .reject(&:empty?)
             .map { |e| e.split("=", 2) }
             .to_h

    # 値の両端の引用符を外す
    kv.transform_values! { |v| v&.gsub(/\A"|"\z/, "") }

    product = kv["DISTRIB_ID"]     || kv["NAME"]     || "Linux"
    version = kv["DISTRIB_RELEASE"]|| kv["VERSION_ID"] || ""
    codename= kv["DISTRIB_CODENAME"] || kv["VERSION_CODENAME"] || ""
    codename = codename.empty? ? "" : " #{codename}"
    puts "#{product} #{version}#{codename}"
  else
    puts "Linux"
  end
  exit 0
end

########################################
# macOS
########################################
if uname =~ /Darwin/
  product_name = `sw_vers -productName`.strip       # "macOS"
  version_str  = `sw_vers -productVersion`.strip    # 例: "26.0.1", "15.1", "11.7.10"

  # major/minor/patch を整数で取得（欠けたら 0 扱い）
  parts = version_str.split(".").map!(&:to_i)
  major, minor, patch = (parts + [0,0,0])[0,3]

  # 11 以降は major で判定、10 系は minor で判定
  macos_name =
    if major >= 26
      "Tahoe"
    elsif major == 15
      "Sequoia"
    elsif major == 14
      "Sonoma"
    elsif major == 13
      "Ventura"
    elsif major == 12
      "Monterey"
    elsif major == 11
      "Big Sur"
    elsif major == 10
      case minor
      when 15 then "Catalina"
      when 14 then "Mojave"
      when 13 then "High Sierra"
      when 12 then "Sierra"
      when 11 then "El Capitan"
      when 10 then "Yosemite"
      else         "Unknown"
      end
    else
      "Unknown"
    end

  puts "#{product_name} #{version_str} #{macos_name}"
  exit 0
end

puts "Unknown OS"
