#!/usr/bin/env node

const { execSync } = require('child_process');
const fs = require('fs');

const HELP = `  display os version

  $ os
  Ubuntu 17.04 zesty
  macOS 26.0 Tahoe`;

if (process.argv[2] === '-h') {
  console.log(HELP);
  process.exit(0);
}

const uname = execSync('uname', { encoding: 'utf8' }).trim();

if (/Linux/.test(uname)) {
  const relPath = ['/etc/lsb-release', '/etc/os-release'].find(p => fs.existsSync(p));
  if (relPath) {
    const kv = {};
    fs.readFileSync(relPath, 'utf8').split('\n')
      .filter(l => !l.startsWith('#') && l.trim())
      .forEach(l => {
        const [k, ...rest] = l.split('=');
        kv[k] = rest.join('=').replace(/^"|"$/g, '');
      });
    const product = kv.DISTRIB_ID || kv.NAME || 'Linux';
    const version = kv.DISTRIB_RELEASE || kv.VERSION_ID || '';
    const codename = kv.DISTRIB_CODENAME || kv.VERSION_CODENAME || '';
    console.log(`${product} ${version}${codename ? ' ' + codename : ''}`);
  } else {
    console.log('Linux');
  }
  process.exit(0);
}

if (/Darwin/.test(uname)) {
  const productName = execSync('sw_vers -productName', { encoding: 'utf8' }).trim();
  const versionStr = execSync('sw_vers -productVersion', { encoding: 'utf8' }).trim();
  const [major, minor] = versionStr.split('.').map(Number);

  const macosNames = { 26: 'Tahoe', 15: 'Sequoia', 14: 'Sonoma', 13: 'Ventura', 12: 'Monterey', 11: 'Big Sur' };
  const mac10Names = { 15: 'Catalina', 14: 'Mojave', 13: 'High Sierra', 12: 'Sierra', 11: 'El Capitan', 10: 'Yosemite' };

  let name;
  if (major >= 26) name = 'Tahoe';
  else if (macosNames[major]) name = macosNames[major];
  else if (major === 10) name = mac10Names[minor] || 'Unknown';
  else name = 'Unknown';

  console.log(`${productName} ${versionStr} ${name}`);
  process.exit(0);
}

console.log('Unknown OS');
